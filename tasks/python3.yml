---

- name: Install python3 build dependencies
  become: true
  yum:
    name:
      - bzip2-devel
      - libffi-devel
      - openssl-devel
      - sqlite-devel
      - xz-devel
      - uuid-devel
  tags: ['python']

- name: Check existing versions
  stat:
    path: "/usr/local/bin/{{ item[:3] }}"
  register: python_stats
  with_items: "{{ python_versions }}"
  tags: ['python']

- name: Debug
  debug: var=python_stats
  tags: ['python']

- name: Install python versions
  become: true
  shell: |
    cd /usr/src
    wget https://www.python.org/ftp/python/{{ item }}\
    /Python-{{ item }}.tgz
    tar xzf Python-{{ item }}.tgz
    cd Python-{{ item }}
    ./configure --enable-optimizations
    make altinstall --exec-prefix=/usr/local
    cd ..
    rm Python-{{ item }}.tgz
    # ln -fs /usr/local/bin/python{{ item[:3]  }} \
    # /usr/local/bin/python3
    # ln -fs /usr/local/bin/pip{{ item[:3]  }} /usr/local/bin/pip3
  when: not item.stat.exists
  with_items: "{{ python_stats.results }}"
  tags: ['python']

- name: Install pip packages
  pip:
    name:
      - speedtest-cli
    executable: pip3
  tags: ['python']
